import{q as te,r as g,c as se,y as le,E as oe,a as p,o as d,b as o,d as s,w as r,f,A as k,F as D,e as F,z as C,g as h,n as K,t as y,j as ne,h as U,s as re}from"./app-CmJRaKAb.js";import{_ as ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";const de={class:"tickets-page"},ie={class:"page-header"},ce={class:"tickets-layout"},ve={class:"tickets-list"},pe={class:"list-header"},me={key:2,class:"list-items"},_e=["onClick"],ge={class:"ticket-subject"},fe={class:"ticket-meta"},ye={class:"tickets-chat"},be={class:"card-header"},he={class:"card-header"},ke={class:"chat-title"},we={key:0,class:"chat-meta"},Ve={key:0},Ce={key:0,class:"chat-actions"},Me={key:1,class:"chat-body"},Te={class:"messages"},xe={class:"message-header"},Ee={class:"message-author"},je={class:"message-time"},Ue={class:"message-body"},ze={class:"message-input"},Ne={__name:"Index",setup(Be){const z=te(),N=g([]),E=g([]),A=g([]),n=g(null),M=g(""),j=g(!1),T=g(!1),B=g(!1),w=g(!1),i=g({subject:"",category:"support",priority:"normal",target_branch:"",message:""});let I=null;const O=se(()=>{var a,e;return n.value?z.isAdmin||((a=n.value.created_by)==null?void 0:a.id)===((e=z.user)==null?void 0:e.id):!1}),q=a=>({open:"Открыт",in_progress:"В работе",resolved:"Решен",closed:"Закрыт"})[a]||a,P=a=>({low:"Низкий",normal:"Обычный",high:"Высокий",urgent:"Срочный"})[a]||a,R=a=>a==="open"?"info":a==="in_progress"?"warning":a==="resolved"?"success":a==="closed"?"danger":"info",G=(a,e=!1)=>{if(!a)return"";const l=new Date(a.replace(" ","T"));return Number.isNaN(l.getTime())?a:new Intl.DateTimeFormat("ru-RU",{dateStyle:"short",timeStyle:e?"short":void 0}).format(l)},V=async()=>{var a,e,l,u;j.value=!0;try{const c=await C.get("/tickets");N.value=((e=(a=c.data)==null?void 0:a.data)==null?void 0:e.data)??[]}catch(c){ElMessage.error(((u=(l=c.response)==null?void 0:l.data)==null?void 0:u.message)||"Ошибка загрузки тикетов")}finally{j.value=!1}},S=async a=>{var e,l,u,c,v,m;T.value=!0;try{const _=await C.get(`/tickets/${a}`);n.value=((l=(e=_.data)==null?void 0:e.data)==null?void 0:l.ticket)??null,E.value=((c=(u=_.data)==null?void 0:u.data)==null?void 0:c.messages)??[]}catch(_){ElMessage.error(((m=(v=_.response)==null?void 0:v.data)==null?void 0:m.message)||"Ошибка загрузки тикета")}finally{T.value=!1}},Q=a=>{w.value=!1,S(a.id)},W=async()=>{var a,e,l;if(!(!M.value.trim()||!n.value)){T.value=!0;try{const c=(a=(await C.post(`/tickets/${n.value.id}/messages`,{message:M.value})).data)==null?void 0:a.data;c&&E.value.push(c),M.value="",await V()}catch(u){ElMessage.error(((l=(e=u.response)==null?void 0:e.data)==null?void 0:l.message)||"Ошибка отправки сообщения")}finally{T.value=!1}}},X=async()=>{w.value=!0,n.value=null,E.value=[],await Y()},Y=async()=>{var a,e,l;try{const u=await C.get("/tickets/branches");A.value=((a=u.data)==null?void 0:a.data)??[]}catch(u){ElMessage.error(((l=(e=u.response)==null?void 0:e.data)==null?void 0:l.message)||"Ошибка загрузки филиалов")}},Z=async()=>{var a,e,l,u,c;if(!i.value.subject.trim()||!i.value.message.trim()){ElMessage.error("Заполните тему и сообщение");return}B.value=!0;try{const v={...i.value};v.category!=="branch"&&(v.target_branch=null);const m=await C.post("/tickets",v);ElMessage.success(((a=m.data)==null?void 0:a.message)||"Тикет создан"),w.value=!1,await V(),(l=(e=m.data)==null?void 0:e.data)!=null&&l.id&&await S(m.data.data.id),i.value={subject:"",category:"support",priority:"normal",target_branch:"",message:""}}catch(v){ElMessage.error(((c=(u=v.response)==null?void 0:u.data)==null?void 0:c.message)||"Ошибка создания тикета")}finally{B.value=!1}},ee=async()=>{var a,e,l;if(n.value)try{const u=await C.patch(`/tickets/${n.value.id}`,{status:"closed"});n.value=((a=u.data)==null?void 0:a.data)??n.value,await V()}catch(u){ElMessage.error(((l=(e=u.response)==null?void 0:e.data)==null?void 0:l.message)||"Ошибка закрытия тикета")}};return le(async()=>{await V(),I=setInterval(async()=>{w.value||(await V(),n.value&&await S(n.value.id))},15e3)}),oe(()=>{I&&clearInterval(I)}),(a,e)=>{const l=f("el-button"),u=f("el-skeleton"),c=f("el-empty"),v=f("el-tag"),m=f("el-input"),_=f("el-form-item"),b=f("el-option"),L=f("el-select"),ae=f("el-form"),H=f("el-card");return d(),p("div",de,[o("div",ie,[e[9]||(e[9]=o("div",null,[o("h2",null,"Чат и тикеты"),o("p",null,"Общение с техподдержкой, админом и другими филиалами.")],-1)),s(l,{type:"primary",onClick:X},{default:r(()=>[...e[8]||(e[8]=[h("Создать тикет",-1)])]),_:1})]),o("div",ce,[o("div",ve,[o("div",pe,[e[11]||(e[11]=o("span",null,"Тикеты",-1)),s(l,{size:"small",onClick:V,loading:j.value},{default:r(()=>[...e[10]||(e[10]=[h("Обновить",-1)])]),_:1},8,["loading"])]),j.value?(d(),k(u,{key:0,rows:6,animated:""})):N.value.length===0?(d(),k(c,{key:1,description:"Нет тикетов"})):(d(),p("div",me,[(d(!0),p(D,null,F(N.value,t=>{var x;return d(),p("button",{key:t.id,class:K(["ticket-item",{active:((x=n.value)==null?void 0:x.id)===t.id}]),onClick:$=>Q(t)},[o("div",ge,y(t.subject),1),o("div",fe,[s(v,{size:"small",type:R(t.status)},{default:r(()=>[h(y(q(t.status)),1)]),_:2},1032,["type"]),o("span",null,y(G(t.last_message_at||t.created_at)),1)])],10,_e)}),128))]))]),o("div",ye,[w.value?(d(),k(H,{key:0,class:"create-card"},{header:r(()=>[o("div",be,[e[13]||(e[13]=o("span",null,"Новый тикет",-1)),s(l,{text:"",onClick:e[0]||(e[0]=t=>w.value=!1)},{default:r(()=>[...e[12]||(e[12]=[h("Закрыть",-1)])]),_:1})])]),default:r(()=>[s(ae,{"label-position":"top",onSubmit:e[6]||(e[6]=ne(()=>{},["prevent"]))},{default:r(()=>[s(_,{label:"Тема"},{default:r(()=>[s(m,{modelValue:i.value.subject,"onUpdate:modelValue":e[1]||(e[1]=t=>i.value.subject=t),placeholder:"Введите тему"},null,8,["modelValue"])]),_:1}),s(_,{label:"Категория"},{default:r(()=>[s(L,{modelValue:i.value.category,"onUpdate:modelValue":e[2]||(e[2]=t=>i.value.category=t),placeholder:"Выберите категорию"},{default:r(()=>[s(b,{label:"Техподдержка",value:"support"}),s(b,{label:"Админ",value:"admin"}),s(b,{label:"Филиал",value:"branch"}),s(b,{label:"Общий",value:"general"})]),_:1},8,["modelValue"])]),_:1}),s(_,{label:"Приоритет"},{default:r(()=>[s(L,{modelValue:i.value.priority,"onUpdate:modelValue":e[3]||(e[3]=t=>i.value.priority=t),placeholder:"Выберите приоритет"},{default:r(()=>[s(b,{label:"Низкий",value:"low"}),s(b,{label:"Обычный",value:"normal"}),s(b,{label:"Высокий",value:"high"}),s(b,{label:"Срочный",value:"urgent"})]),_:1},8,["modelValue"])]),_:1}),i.value.category==="branch"?(d(),k(_,{key:0,label:"Филиал"},{default:r(()=>[s(L,{modelValue:i.value.target_branch,"onUpdate:modelValue":e[4]||(e[4]=t=>i.value.target_branch=t),placeholder:"Выберите филиал"},{default:r(()=>[(d(!0),p(D,null,F(A.value,t=>(d(),k(b,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):U("",!0),s(_,{label:"Сообщение"},{default:r(()=>[s(m,{modelValue:i.value.message,"onUpdate:modelValue":e[5]||(e[5]=t=>i.value.message=t),type:"textarea",rows:5,placeholder:"Опишите вопрос"},null,8,["modelValue"])]),_:1}),s(l,{type:"primary",loading:B.value,onClick:Z},{default:r(()=>[...e[14]||(e[14]=[h(" Создать ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})):(d(),k(H,{key:1,class:"chat-card"},{header:r(()=>{var t;return[o("div",he,[o("div",null,[o("div",ke,y(((t=n.value)==null?void 0:t.subject)||"Выберите тикет"),1),n.value?(d(),p("div",we,[s(v,{size:"small",type:R(n.value.status)},{default:r(()=>[h(y(q(n.value.status)),1)]),_:1},8,["type"]),s(v,{size:"small",type:"info"},{default:r(()=>[h(y(P(n.value.priority)),1)]),_:1}),n.value.target_branch?(d(),p("span",Ve,"Филиал: "+y(n.value.target_branch),1)):U("",!0)])):U("",!0)]),n.value?(d(),p("div",Ce,[s(l,{size:"small",type:"danger",plain:"",disabled:!O.value,onClick:ee},{default:r(()=>[...e[15]||(e[15]=[h(" Закрыть ",-1)])]),_:1},8,["disabled"])])):U("",!0)])]}),default:r(()=>[n.value?(d(),p("div",Me,[o("div",Te,[(d(!0),p(D,null,F(E.value,t=>{var x,$,J;return d(),p("div",{key:t.id,class:K(["message",{mine:((x=t.user)==null?void 0:x.id)===(($=re(z).user)==null?void 0:$.id)}])},[o("div",xe,[o("span",Ee,y(((J=t.user)==null?void 0:J.full_name)||"Пользователь"),1),o("span",je,y(G(t.created_at,!0)),1)]),o("div",Ue,y(t.body),1)],2)}),128))]),o("div",ze,[s(m,{modelValue:M.value,"onUpdate:modelValue":e[7]||(e[7]=t=>M.value=t),type:"textarea",rows:3,placeholder:"Введите сообщение"},null,8,["modelValue"]),s(l,{type:"primary",loading:T.value,onClick:W},{default:r(()=>[...e[16]||(e[16]=[h(" Отправить ",-1)])]),_:1},8,["loading"])])])):(d(),k(c,{key:0,description:"Выберите тикет из списка"}))]),_:1}))])])])}}},Le=ue(Ne,[["__scopeId","data-v-5e20ae41"]]);export{Le as default};
